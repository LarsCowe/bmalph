import { cp, mkdir, readFile, writeFile, access } from "fs/promises";
import { join, dirname } from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

export function getBmadDir(): string {
  return join(__dirname, "..", "bmad");
}

export function getRalphDir(): string {
  return join(__dirname, "..", "ralph");
}

export async function installProject(projectDir: string): Promise<void> {
  const bmadDir = getBmadDir();
  const ralphDir = getRalphDir();

  // Create directory structure
  await mkdir(join(projectDir, "bmalph/state"), { recursive: true });
  await mkdir(join(projectDir, ".ralph/specs"), { recursive: true });
  await mkdir(join(projectDir, ".ralph/logs"), { recursive: true });
  await mkdir(join(projectDir, ".ralph/lib"), { recursive: true });

  // Copy BMAD files → _bmad/
  await cp(bmadDir, join(projectDir, "_bmad"), { recursive: true });

  // Generate _bmad/config.yaml
  await writeFile(
    join(projectDir, "_bmad/config.yaml"),
    `# BMAD Configuration - Generated by bmalph
platform: claude-code
output_dir: _bmad-output
modules:
  - bmm
`,
  );

  // Copy Ralph templates → .ralph/
  await cp(
    join(ralphDir, "templates/PROMPT.md"),
    join(projectDir, ".ralph/PROMPT.md"),
  );
  await cp(
    join(ralphDir, "templates/AGENT.md"),
    join(projectDir, ".ralph/@AGENT.md"),
  );

  // Copy Ralph loop and lib → .ralph/
  await cp(join(ralphDir, "ralph_loop.sh"), join(projectDir, ".ralph/ralph_loop.sh"));
  await cp(join(ralphDir, "lib"), join(projectDir, ".ralph/lib"), { recursive: true });

  // Update .gitignore
  await updateGitignore(projectDir);
}

async function updateGitignore(projectDir: string): Promise<void> {
  const gitignorePath = join(projectDir, ".gitignore");
  let existing = "";

  try {
    existing = await readFile(gitignorePath, "utf-8");
  } catch {
    // File doesn't exist, start fresh
  }

  const entries = [".ralph/logs/", "_bmad-output/"];
  const newEntries = entries.filter((e) => !existing.includes(e));

  if (newEntries.length === 0) return;

  const suffix =
    existing.length > 0 && !existing.endsWith("\n")
      ? "\n" + newEntries.join("\n") + "\n"
      : newEntries.join("\n") + "\n";

  await writeFile(gitignorePath, existing + suffix);
}

export async function mergeClaudeMd(projectDir: string): Promise<void> {
  const claudeMdPath = join(projectDir, "CLAUDE.md");
  const snippet = `
## BMAD-METHOD Integration

This project uses BMAD-METHOD for structured AI development planning.

### Loading BMAD Master Agent

Load the BMAD master agent to access all workflows:
\`\`\`
Read and follow the instructions in _bmad/core/agents/bmad-master.agent.yaml
\`\`\`

### Available Workflows

- Phase 1 (Analysis): BP, MR, DR, TR, CB, VB
- Phase 2 (Planning): CP, VP, CU, VU
- Phase 3 (Solutioning): CA, VA, CE, VE, TD, IR
- Phase 4 (Implementation): Handled by Ralph autonomous loop

### Quick Commands

- \`bmalph plan --phase 1\` — Set active phase and see available commands
- \`bmalph implement\` — Transition to Ralph implementation loop
- \`bmalph status\` — Show current progress
`;

  let existing = "";
  try {
    existing = await readFile(claudeMdPath, "utf-8");
  } catch {
    // File doesn't exist, that's fine
  }

  if (existing.includes("## BMAD-METHOD Integration")) {
    return; // Already merged
  }

  await writeFile(claudeMdPath, existing + snippet);
}

export async function isInitialized(projectDir: string): Promise<boolean> {
  try {
    await access(join(projectDir, "bmalph/config.json"));
    return true;
  } catch {
    return false;
  }
}
